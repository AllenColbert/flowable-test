<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>任务列表</title>
    <script th:src="@{/js/jquery-3.3.1.js}"></script>
    <link th:href="@{/css/style.css}" rel="stylesheet" type="text/css">
</head>
<body>
<div id="heard"  th:replace="header.html :: header"></div>

<div id="buttons-hbox">
    <button id="tanchu" onclick="show()">填写任务数据</button>
</div>

<!--遮罩层div-->
<div class="zhezhao"></div>

<!--弹出层div-->
<div class="remove" title="完成任务" >
    <button id="guanbi" onclick="hide()">关闭</button>
    <form id="form1" action="#" method="post" name="form1">
        <table id="table1">
            <tr>
                <td>参数1:</td>
                <td>
                    <label>
                    <input type="text" placeholder="参数1" name="taskId" >
                    </label>
                </td>
            </tr>
            <tr>
                <td>参数2:</td>
                <td>
                    <label>
                        <input type="text" placeholder="参数2"  name="targetNode" >
                    </label>
                </td>
            </tr>
            <tr>
                <td>参数3:</td>
                <td>
                    <label>
                        <input type="text" placeholder="参数3" name="assignee">
                    </label>
                </td>
            </tr>
            <tr>
                <td><input type="button" id="form1_submit" value="提交参数"></td>
            </tr>
        </table>
    </form>
</div>

<div id="bodyBox">
    <div id="inputBox" style=" padding-left: 8% ;margin: 0 0 10px 40px">
        <label for="assignee">在这里输入Assignee：</label>
        <input type="text" id="assignee" placeholder="设置任务代办人">
    </div>

    <div id="mainBox" th:align="center">
    <table th:class="gridtable" >
        <thead>
        <th>任务Id</th>
        <th>任务名称</th>
    <!--<th>任务执行Id</th>-->
    <!--<th>流程实例Id</th>-->
    <!--<th>流程定义Id</th>-->
    <!--<th>任务定义Id</th>-->
        <th>代理人</th>
        <th>创建时间</th>
        <th>任务状态</th>
        <th>租户Id</th>
    <!--<th>表单key</th>-->
        <th>操作空间</th>
        </thead>
        <tbody>
        <tr th:each="task:${tasks}">
            <td th:text="${task.id}" ></td>
            <td th:text="${task.name}"></td>
            <!--<td th:text="${task.executionId}"></td>-->
            <!--<td th:text="${task.processInstanceId}"></td>-->
            <!--<td th:text="${task.processDefinitionId}"></td>-->
            <!--<td th:text="${task.taskDefinitionKey}"></td>-->
            <td th:text="${task.assignee}"></td>
            <td th:text="${#dates.format(task.createTime, 'yyyy-MM-dd HH:mm:ss')}" ></td>
            <td th:text="${task.suspensionState} eq 1? '运行中':'已挂起'"></td>
            <td th:text="${task.tenantId}"></td>
            <!--<td th:text="${task.formKey}"></td>-->
            <td >
                <!--<button  th:value="${task.id}"  onclick="completeTask(value)">完成任务</button>-->
                <button  th:value="${task.id}" th:class="button3" onclick="completeTaskWithAssignee(value)">完成任务</button>
                <button th:value="${task.processInstanceId}" th:class="button3" style="background-color: #1b6d85" onclick="showImage(value)">显示流程图</button>
                <button th:value="${task.processInstanceId}" th:class="button3" style="background-color: #1754c2" onclick="suspendTask(value)">挂起</button>
                <button th:value="${task.processInstanceId}" th:class="button3" style="background-color: #c28c63" onclick="activateTask(value)">激活</button>
            </td>
            </tr>
           </tbody>
      </table>
    </div>

    <div id="imgDiv" style="border-image-width: auto;text-align: center"></div>

</div>

</body>

<script>

/*    $.fn.serializeObject = function() {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
            if (o[this.name]) {
                if (!o[this.name].push) {
                    o[this.name] = [ o[this.name] ];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };*/

    $(function () {

        $("#form1_submit").click(function () {
            var formData = $("#form1").serializeArray();
            console.log('原始数据'+formData);
            var newVar = formData[0];
            console.log('newVar:'+newVar);
            //var parse = JSON.parse(formData);
            //console.log('解析数据1'+parse);
            var jsonData = JSON.stringify(formData);
            console.log('jsonDate'+jsonData);
            var resultJson = $.parseJSON(jsonData);

            console.log(resultJson);
            $.post("/data",{"formData":jsonData},function (result) {
                console.log(result);
            });
        })
    });

/*    function data_view() {
        var data = $('form[id="form1"]').serialize();
        var data2 = $('form[id="form1"]').serializeObject();
        //var data3 = $('form[id="form1"]').serializeArray();
        console.log(data);
        console.log(data2);
       // console.log(data3);
        window.alert(data);
    }*/



    function show() {
        show_zhe_zhao();
        show_tan_chuang();
    }

    function hide() {
        hide_zhe_zhao();
        hide_tan_chuang();
    }

     function show_zhe_zhao(){
         $('.zhezhao').css('display', 'block');
     }

     function hide_zhe_zhao() {
         $('.zhezhao').css('display', 'none');
     }

     function show_tan_chuang() {
         $('.remove').css('display','block')
     }

     function hide_tan_chuang() {
        $('.remove').css('display','none')
     }



    function showImage(processInstanceId) {
        console.log('processInstanceId:'+processInstanceId);
        $("#imgDiv").empty().append("<img src='/task/processDiagram?processInstanceId="+processInstanceId+"'>")
    }

    function completeTaskWithAssignee(taskId) {

        var assignee = $("#assignee").val();

        $.post("/task/completeTask",{"taskId":taskId,"assignee":assignee},function (result) {
            if (result.code === 200){
                reload();
            }
            if (result.code !== 200){
                showMsg(result.msg);
            }
        })
    }

    function logout() {
        $.get("/idm/logout",function () {
            window.location.href="/";
        });
    }

    function suspendTask(processInstanceId) {
        $.get("/task/suspendProcessInstanceById",{"processInstanceId":processInstanceId},function (result) {

            if (result.code === 200){
                reload();
            }
            if (result.code !== 200){
                showMsg(result.msg);
            }

        })
    }

    function activateTask(processInstanceId) {
        $.get("/task/activateProcessInstanceById",{"processInstanceId":processInstanceId},function (result) {
            if (result.code === 200){
                reload();
            }
            if (result.code !== 200){
                showMsg(result.msg);
            }
        })
    }

    function sendData(data) {
        $.post("/data",{"data":data},function (result) {
            console.log(result.data)
        });
    }
</script>
</html>
